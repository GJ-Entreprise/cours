<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>FAOU_Julien_Evidence - Cours - GJ enterprise</title>
  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "FAOU_Julien_Evidence";
    var mkdocs_page_input_path = "forensic/evidence/FAOU_Julien_Evidence.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Cours - GJ enterprise</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <span class="caption-text">cloud & IOT</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../cloud_&_IOT/cloud_computing/">Cloud computing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../cloud_&_IOT/cours/">FAOU_Julien_Stuxnet</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Forensic</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../autopsy/">Autopsy</a>
                </li>
                <li class="">
                    
    <a class="" href="../../cours_forensic/">Forensic</a>
                </li>
                <li class=" current">
                    
    <span class="caption-text">Evidence</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../Evidence/">Evidence</a>
                </li>
                <li class="toctree-l3 current">
                    
    <a class="current" href="./">FAOU_Julien_Evidence</a>
    <ul class="subnav">
            
    <li class="toctree-l4"><a href="#partie-1">Partie 1</a></li>
    

    <li class="toctree-l4"><a href="#partie-2">Partie 2</a></li>
    
        <ul>
        
            <li><a class="toctree-l5" href="#informations">Informations</a></li>
        
            <li><a class="toctree-l5" href="#analyse-memoire">Analyse mémoire</a></li>
        
            <li><a class="toctree-l5" href="#analyse-des-traces-reseaux">Analyse des traces réseaux</a></li>
        
        </ul>
    

    <li class="toctree-l4"><a href="#partie-3">Partie 3</a></li>
    
        <ul>
        
            <li><a class="toctree-l5" href="#analyse-du-disque">Analyse du disque</a></li>
        
            <li><a class="toctree-l5" href="#scan-antivirus">Scan antivirus</a></li>
        
            <li><a class="toctree-l5" href="#historique-de-firefox">Historique de firefox</a></li>
        
        </ul>
    

    <li class="toctree-l4"><a href="#partie-4">Partie 4</a></li>
    

    <li class="toctree-l4"><a href="#partie-5">Partie 5</a></li>
    

    <li class="toctree-l4"><a href="#partie-6">Partie 6</a></li>
    

    <li class="toctree-l4"><a href="#partie-7">Partie 7</a></li>
    

    </ul>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Exercices</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../exercices/dump_mem_disk/">Dump mémoire et disque dur</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">Volatility</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../exercices/volatility/exercice2/">Forensic exercice 2 - Volatility</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Stuxnet</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../stuxnet/Julien_Faou_Stuxnet/">FAOU_Julien_Stuxnet</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Management</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../management/Partiel_droit_Julien_Faou/">Partiel droit</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../management/STMicroelectronics/">STMicroelectronics</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../management/donnes_personnelles/">Comment traiter les données collectées ?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../management/exploitation_base_de_donne/">L'exploitation de base de données</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../management/proteger_le_travail/">Proteger le travail</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Memoire entreprise</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../memoire_entreprise/instruction_memoire_entreprise/">Instruction memoire entreprise</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Methodologie pentest</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../methodologie_pentest/cours/">Enumération passive</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../methodologie_pentest/cyberwings/">Collect email</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../methodologie_pentest/methodologie_pentest/">Méthodologie de pentest</a>
                </li>
                <li class="">
                    
    <span class="caption-text">ISSAF</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../methodologie_pentest/ISSAF/DE-ICE-110/">DE-ICE-110 - Pentest</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../methodologie_pentest/ISSAF/GoldenEye-V1/">GoldenEye V1</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../methodologie_pentest/ISSAF/template_ISSAF/">Méthodologie template - Pentest</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Exercices</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../methodologie_pentest/exercices/sectools.org/">Sectools.org</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Wiki</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../methodologie_pentest/wiki/pentesting_ftp/">Pentesting FTP</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../methodologie_pentest/wiki/privilege_escalation/">Gather system informations</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Reseaux industriels</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../reseaux_industriels/grafcet/">Graphset</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../reseaux_industriels/reseaux_industriel/">Réseaux industriels</a>
                </li>
                <li class="">
                    
    <span class="caption-text">Exercice</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <span class="caption-text">Grafcet</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../reseaux_industriels/exercice/grafcet/grafcet_instructions/">Grafcet instructions</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">Modbus</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../reseaux_industriels/exercice/modbus/exercice_modbus/">Exercices modbus</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Securite reseaux industrielles</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../securite_reseaux_industrielles/cours/">Securité des réseaux industriels</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">securité IOT</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../securité_IOT/cours/">Cours</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Cours - GJ enterprise</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Evidence &raquo;</li>
        
      
        
          <li>Forensic &raquo;</li>
        
      
    
    <li>FAOU_Julien_Evidence</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="partie-1">Partie 1</h1>
<p><strong>Schéma de l'attaque telle que vous avez réussi à la reconstruire</strong></p>
<blockquote>
<p>Les éléments de preuves qui m'ont permis de retrouver le schéma de l'atttaque sont détaillés dans les parties 2 et 3.</p>
</blockquote>
<p>1) L'utilisateur se rend sur le blog de son entreprise</p>
<p>2) Le site été compris, injection de code JS, redirection vers le blog d'un autre site.</p>
<p>3) Le cache de son navigateur firefox à été infecté par un RAT (Remote Access Trojan)</p>
<p>4) Le RAT a téléchargé de nombreux outils d'audit depuis un serveur</p>
<p>5) Probablement auditer l'ensemble du parc réseaux et exfiltrer des données.</p>
<h1 id="partie-2">Partie 2</h1>
<p><strong>Elements de d'indices collectés dans volatility</strong></p>
<h2 id="informations">Informations</h2>
<blockquote>
<p><strong>Le disque Evidence a été monté en READ-ONLY : /media/sdb1/Window/</strong></p>
<p><strong>L'outil volatility se trouve au chemin suivant : ~/training/tools/volatility/vol.py</strong></p>
</blockquote>
<h2 id="analyse-memoire">Analyse mémoire</h2>
<h3 id="systeme-informations">Systeme informations</h3>
<pre><code class="text">sudo ./vol.py -f /media/sdb1/Windows/memory.img imageinfo

Volatility Foundation Volatility Framework 2.5
INFO    : volatility.debug    : Determining profile based on KDBG search...
          Suggested Profile(s) : Win10x86, Win8SP0x86, Win81U1x86, Win8SP1x86, Win10x86_44B89EEA
                     AS Layer1 : IA32PagedMemoryPae (Kernel AS)
                     AS Layer2 : FileAddressSpace (/media/sdb1/Windows/memory.img)
                      PAE type : PAE
                           DTB : 0x1a8000L
                          KDBG : 0x82461820L
          Number of Processors : 1
     Image Type (Service Pack) : 0
                KPCR for CPU 0 : 0x8248b000L
             KUSER_SHARED_DATA : 0xffdf0000L
           Image date and time : 2016-08-17 12:00:47 UTC+0000
     Image local date and time : 2016-08-17 14:00:47 +0200
</code></pre>

<p>On obtient des versions potentiels ainsi que les adresses de DTB, KDBG et KPCR qu'il faudra préciser.</p>
<p>Après plusieurs essais, le bon profile est : <strong>Win10x86_44B89EEA</strong></p>
<pre><code class="text">sudo ./vol.py -f /media/sdb1/Windows/memory.img --dtb=0x1a8000 --kdbg=0x82461820 --kpcr=0x8248b000 --profile=Win10x86_44B89EEA pslist

Offset(V)  Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                          Exit                          
---------- -------------------- ------ ------ ------ -------- ------ ------ ------------------------------ ------------------------------
0x868a7700 System                    4      0    104        0 ------      0 2016-08-16 12:54:24 UTC+0000                                 
0x8d2af5c0 smss.exe                244      4      2        0 ------      0 2016-08-16 12:54:24 UTC+0000                                 
0x8f7e3040 csrss.exe               324    316     10        0      0      0 2016-08-16 12:54:27 UTC+0000                                 
0x9487c640 smss.exe                388    244      0 --------      1      0 2016-08-16 12:54:28 UTC+0000   2016-08-16 12:54:28 UTC+0000  
0x8b9bf300 wininit.exe             396    316      2        0      0      0 2016-08-16 12:54:28 UTC+0000                                 
0x8f71d2c0 csrss.exe               408    388     11        0      1      0 2016-08-16 12:54:28 UTC+0000                                 
0x94863c40 winlogon.exe            460    388      4        0      1      0 2016-08-16 12:54:28 UTC+0000                                 
0x8b9bc300 services.exe            488    396      6        0      0      0 2016-08-16 12:54:29 UTC+0000                                 
0x948c3040 lsass.exe               516    396      7        0      0      0 2016-08-16 12:54:29 UTC+0000                                 
0x948fb180 svchost.exe             576    488     19        0      0      0 2016-08-16 12:54:30 UTC+0000                                 
0x94954380 svchost.exe             620    488     10        0      0      0 2016-08-16 12:54:30 UTC+0000                                 
0x949bdc40 dwm.exe                 716    460     13        0      1      0 2016-08-16 12:54:31 UTC+0000                                 
0x949b08c0 svchost.exe             764    488     16        0      0      0 2016-08-16 12:54:31 UTC+0000                                 
0x9495d6c0 svchost.exe             800    488     46        0      0      0 2016-08-16 12:54:31 UTC+0000                                 
0x949d3040 svchost.exe             848    488     24        0      0      0 2016-08-16 12:54:31 UTC+0000                                 
0x949d3c40 svchost.exe             856    488     10        0      0      0 2016-08-16 12:54:31 UTC+0000                                 
0x949faac0 svchost.exe             896    488     22        0      0      0 2016-08-16 12:54:31 UTC+0000                                 
0x94ca1700 svchost.exe            1068    488     24        0      0      0 2016-08-16 12:54:32 UTC+0000                                 
0x94caf040 svchost.exe            1132    488     24        0      0      0 2016-08-16 12:54:32 UTC+0000                                 
0x9a018040 spoolsv.exe            1212    488     10        0      0      0 2016-08-16 12:54:32 UTC+0000                                 
0x9a039040 svchost.exe            1380    488     12        0      0      0 2016-08-16 12:54:34 UTC+0000                                 
0x9a118380 svchost.exe            1540    488      7        0      0      0 2016-08-16 12:54:34 UTC+0000                                 
0x9a10cb00 wlms.exe               1572    488      4        0      0      0 2016-08-16 12:54:34 UTC+0000                                 
0x9c64f980 sihost.exe              688    800     12        0      1      0 2016-08-16 12:55:35 UTC+0000                                 
0x8c13ea00 taskhostw.exe           268    800      9        0      1      0 2016-08-16 12:55:36 UTC+0000                                 
0x8ad6c040 userinit.exe           1556    460      0 --------      1      0 2016-08-16 12:55:36 UTC+0000   2016-08-16 12:55:59 UTC+0000  
0x8ac4a040 explorer.exe           2068   1556     57        0      1      0 2016-08-16 12:55:36 UTC+0000                                 
0x8ad60940 RuntimeBroker.         2196    576     21        0      1      0 2016-08-16 12:55:37 UTC+0000                                 
0x8ad5f040 SkypeHost.exe          2220    576     10        0      1      0 2016-08-16 12:55:37 UTC+0000                                 
0x8ad22c40 ShellExperienc         2432    576     38        0      1      0 2016-08-16 12:55:39 UTC+0000                                 
0x8b8520c0 SearchIndexer.         2532    488     17        0      0      0 2016-08-16 12:55:40 UTC+0000                                 
0x8b8fb8c0 OneDrive.exe           3592   2068     14        0      1      0 2016-08-16 12:55:57 UTC+0000                                 
0x9c68ec40 fontdrvhost.ex         4428    460      6        0      1      0 2016-08-16 12:57:09 UTC+0000                                 
0x9c728480 svchost.exe            4900    488      3        0      1      0 2016-08-16 12:57:21 UTC+0000                                 
0x8ad86c40 Skype.exe              5128   4696     64        0      1      0 2016-08-16 12:57:42 UTC+0000                                 
0x8c0c9240 TrustedInstall         6108    488      4        0      0      0 2016-08-16 12:58:24 UTC+0000                                 
0x8c0ba9c0 TiWorker.exe           6140    576      5        0      0      0 2016-08-16 12:58:25 UTC+0000                                 
0x9d489780 SystemSettings         2144    576      4        0      1      0 2016-08-16 12:59:36 UTC+0000                                 
0x9499ac40 ApplicationFra         1696    576      5        0      1      0 2016-08-16 12:59:48 UTC+0000                                 
0x9c629300 SystemSettings         5268   5252      4        0      1      0 2016-08-16 12:59:51 UTC+0000                                 
0xb0d47780 svchost.exe            4888   4748      2        0      1      0 2016-08-16 13:02:57 UTC+0000                                 
0x9d5e74c0 explorer.exe           4872   4748      3        0      1      0 2016-08-16 13:02:58 UTC+0000                                 
0x9c7d7c40 svchost.exe            2168   5860      2        0      1      0 2016-08-16 13:03:04 UTC+0000                                 
0xb0c96740 update.exe             5172   5860      6        0      1      0 2016-08-16 13:03:04 UTC+0000                                 
0xd0d9f600 cmd.exe                1976   5172      0 --------      1      0 2016-08-16 13:04:47 UTC+0000   2016-08-16 13:07:36 UTC+0000  
0x9d5ba900 cmd.exe                 736   5172      0 --------      1      0 2016-08-16 13:07:40 UTC+0000   2016-08-16 13:43:12 UTC+0000  
0xbac89640 SystemSettings         4968    576     26        0      1      0 2016-08-16 13:41:14 UTC+0000                                 
0xbad4b040 cmd.exe                2748   5172      0 --------      1      0 2016-08-16 13:50:51 UTC+0000   2016-08-16 14:08:30 UTC+0000  
0xbf755c40 cmd.exe                5280   5172      0 --------      1      0 2016-08-16 14:17:24 UTC+0000   2016-08-16 14:18:48 UTC+0000  
0x8b8c44c0 cmd.exe                 868   5172      0 --------      1      0 2016-08-16 14:19:45 UTC+0000   2016-08-16 14:23:02 UTC+0000  
0xd53d2c40 cmd.exe                3540   5172      0 --------      1      0 2016-08-16 14:23:05 UTC+0000   2016-08-16 14:23:46 UTC+0000  
0xd5321480 SearchUI.exe           7360    576     26        0      1      0 2016-08-16 18:13:21 UTC+0000                                 
0x9c6a8040 audiodg.exe           18084    848      7        0      0      0 2016-08-17 12:00:20 UTC+0000                                 
0xc8606c40 RamCapture.exe        16740   2068      4        0      1      0 2016-08-17 12:00:36 UTC+0000                                 
0xd53a3500 conhost.exe           16756  16740      2        0      1      0 2016-08-17 12:00:36 UTC+0000                                 
0x9c61a300 SearchProtocol        15756   2532      7        0 ------      0 2016-08-17 12:00:50 UTC+0000                                 
0xc7fa2a40 SearchFilterHo        14288   2532      5        0 ------      0 2016-08-17 12:00:50 UTC+0000                                 
0xe2df3040 MusNotificatio        16968    800      1        0 ------      0 2016-08-18 09:25:38 UTC+0000                                 
0xb0df7040 ?q???q??                  0      0 22...6 -------- ------      0
</code></pre>

<p>Pour simplifier les futurs commandes, nous utiliserons un alias.</p>
<pre><code class="text">alias vol=&quot;sudo ~/training/tools/volatility/vol.py -f /media/sdb1/Windows/memory.img --dtb=0x1a8000 --kdbg=0x82461820 --kpcr=0x8248b000 --profile=Win10x86_44B89EEA&quot;
</code></pre>

<h3 id="scan-malware">Scan Malware</h3>
<p>Commençons par scanner pour de potentiels malware, nous allons utiliser les Yara-rules.</p>
<p>Les yara-rules se trouvent dans le dossier : <strong>~/training/ex1/yara-rules/</strong></p>
<p>Pour éviter des faux-positifs, on va trier ces yara-rules pour ne sélectionner que celles qui sont pertinantes dans notre cas.</p>
<pre><code class="bash">find CVE_Rules/ Exploit-Kits/ malware/ -name &quot;*.yar&quot; -exec echo include \&quot;`pwd`/{}\&quot; \; &gt; test.yar
</code></pre>

<p>Lançons le scan</p>
<pre><code class="bash">vol yarascan -y test.yar &gt; results.txt
</code></pre>

<p>Obtenir un résumé des règles détecter par YARA rules :</p>
<pre><code class="bash">grep 'Rule:' results.txt  | sort | uniq -c

15 Rule: SharedStrings
3 Rule: spyeye_plugins
9 Rule: UPX
51 Rule: with_sqlite
18 Rule: Xtreme
9 Rule: xtreme_rat
19 Rule: xtremrat
</code></pre>

<p>Analysons tout cela plus en détails : </p>
<p><strong>SharedStrings</strong></p>
<pre><code class="bash">grep -Rl 'rule SharedStrings' *

malware/MALW_LURK0.yar
</code></pre>

<pre><code class="txt">rule SharedStrings : Family {
    meta:
        description = &quot;Internal names found in LURK0/CCTV0 samples&quot;
        author = &quot;Katie Kleemola&quot;
        last_updated = &quot;07-22-2014&quot;

    strings:
        // internal names
        $i1 = &quot;Butterfly.dll&quot;
        $i2 = /\\BT[0-9.]+\\ButterFlyDLL\\/
        $i3 = &quot;ETClientDLL&quot;

        // dbx
        $d1 = &quot;\\DbxUpdateET\\&quot; wide
        $d2 = &quot;\\DbxUpdateBT\\&quot; wide
        $d3 = &quot;\\DbxUpdate\\&quot; wide

        // other folders
        $mc1 = &quot;\\Micet\\&quot;

        // embedded file names
        $n1 = &quot;IconCacheEt.dat&quot; wide
        $n2 = &quot;IconConfigEt.dat&quot; wide

        $m1 = &quot;\x00\x00ERXXXXXXX\x00\x00&quot; wide
        $m2 = &quot;\x00\x00111\x00\x00&quot; wide
        $m3 = &quot;\x00\x00ETUN\x00\x00&quot; wide
        $m4 = &quot;\x00\x00ER\x00\x00&quot; wide

    condition:
        any of them //todo: finetune this

}
</code></pre>

<pre><code class="bash">$m4 = &quot;\x00\x00ER\x00\x00&quot;
</code></pre>

<p>C'est cette ligne qui a fait topé, elle est très générique et ne nous donne vraiment d'information suplémentaire. Probablement un faux positif.</p>
<hr />
<p><strong>spyeye_plugins</strong> : Faux positif au vu des chaines recherchées</p>
<hr />
<p><strong>UPX</strong></p>
<pre><code class="bash">grep -Rl 'rule UPX' *

training/ex1/yara-rules/malware/RAT_Ratdecoders.yar
</code></pre>

<p>Identification des processus : </p>
<pre><code class="bash">grep -i -A 1 'UPX' /home/student/yara-out.txt  | grep Owner | uniq -c

3 Owner: Process svchost.exe Pid 4888
3 Owner: Process explorer.exe Pid 4872
3 Owner: Process update.exe Pid 5172
</code></pre>

<hr />
<p><strong>with_sqlite</strong> : Beaucoup d'occurence, il est difficile de dire si c'est un faux positif ou non, il faudra le déterminer avec la timeline.</p>
<hr />
<p><strong>xtremrat</strong></p>
<pre><code class="bash">grep -Rl 'rule xtremrat' *

malware/RAT_Xtreme.yar
</code></pre>

<pre><code class="text">rule xtreme_rat : Trojan
{
    meta:
        author=&quot;Kevin Falcoz&quot;
        date=&quot;23/02/2013&quot;
        description=&quot;Xtreme RAT&quot;

    strings:
        $signature1={58 00 54 00 52 00 45 00 4D 00 45} /*X.T.R.E.M.E*/

    condition:
        $signature1
}
</code></pre>

<p>Identification des process</p>
<pre><code class="text">grep -i -A 1 'xtremrat' /home/student/yara-out.txt  | grep Owner | uniq -c

11 Owner: Process explorer.exe Pid 4872
8 Owner: Process update.exe Pid 5172
</code></pre>

<p>On retrouve <strong>ER</strong> dans la signature : </p>
<pre><code class="bash">__/*X.T.R.E.M.E*/__  =&gt;  __$m4 = &quot;\x00\x00ER\x00\x00&quot; wide__
</code></pre>

<p>Identification des processus :</p>
<ul>
<li>Process svchost.exe Pid 4888</li>
<li>Process explorer.exe Pid 4872</li>
<li>Process update.exe Pid 5172</li>
</ul>
<p><strong>xtremrat</strong> est notre piste la plus plausible.</p>
<h3 id="scan-des-processus">Scan des processus</h3>
<pre><code class="text">vol pslist

Volatility Foundation Volatility Framework 2.5
Offset(V)  Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                          Exit                          
---------- -------------------- ------ ------ ------ -------- ------ ------ ------------------------------ ------------------------------
0x868a7700 System                    4      0    104        0 ------      0 2016-08-16 12:54:24 UTC+0000                                 
0x8d2af5c0 smss.exe                244      4      2        0 ------      0 2016-08-16 12:54:24 UTC+0000                                 
0x8f7e3040 csrss.exe               324    316     10        0      0      0 2016-08-16 12:54:27 UTC+0000                                 
0x9487c640 smss.exe                388    244      0 --------      1      0 2016-08-16 12:54:28 UTC+0000   2016-08-16 12:54:28 UTC+0000  
0x8b9bf300 wininit.exe             396    316      2        0      0      0 2016-08-16 12:54:28 UTC+0000                                 
0x8f71d2c0 csrss.exe               408    388     11        0      1      0 2016-08-16 12:54:28 UTC+0000                                 
0x94863c40 winlogon.exe            460    388      4        0      1      0 2016-08-16 12:54:28 UTC+0000                                 
0x8b9bc300 services.exe            488    396      6        0      0      0 2016-08-16 12:54:29 UTC+0000                                 
0x948c3040 lsass.exe               516    396      7        0      0      0 2016-08-16 12:54:29 UTC+0000                                 
0x948fb180 svchost.exe             576    488     19        0      0      0 2016-08-16 12:54:30 UTC+0000                                 
0x94954380 svchost.exe             620    488     10        0      0      0 2016-08-16 12:54:30 UTC+0000                                 
0x949bdc40 dwm.exe                 716    460     13        0      1      0 2016-08-16 12:54:31 UTC+0000                                 
0x949b08c0 svchost.exe             764    488     16        0      0      0 2016-08-16 12:54:31 UTC+0000                                 
0x9495d6c0 svchost.exe             800    488     46        0      0      0 2016-08-16 12:54:31 UTC+0000                                 
0x949d3040 svchost.exe             848    488     24        0      0      0 2016-08-16 12:54:31 UTC+0000                                 
0x949d3c40 svchost.exe             856    488     10        0      0      0 2016-08-16 12:54:31 UTC+0000                                 
0x949faac0 svchost.exe             896    488     22        0      0      0 2016-08-16 12:54:31 UTC+0000                                 
0x94ca1700 svchost.exe            1068    488     24        0      0      0 2016-08-16 12:54:32 UTC+0000                                 
0x94caf040 svchost.exe            1132    488     24        0      0      0 2016-08-16 12:54:32 UTC+0000                                 
0x9a018040 spoolsv.exe            1212    488     10        0      0      0 2016-08-16 12:54:32 UTC+0000                                 
0x9a039040 svchost.exe            1380    488     12        0      0      0 2016-08-16 12:54:34 UTC+0000                                 
0x9a118380 svchost.exe            1540    488      7        0      0      0 2016-08-16 12:54:34 UTC+0000                                 
0x9a10cb00 wlms.exe               1572    488      4        0      0      0 2016-08-16 12:54:34 UTC+0000                                 
0x9c64f980 sihost.exe              688    800     12        0      1      0 2016-08-16 12:55:35 UTC+0000                                 
0x8c13ea00 taskhostw.exe           268    800      9        0      1      0 2016-08-16 12:55:36 UTC+0000                                 
0x8ad6c040 userinit.exe           1556    460      0 --------      1      0 2016-08-16 12:55:36 UTC+0000   2016-08-16 12:55:59 UTC+0000  
0x8ac4a040 explorer.exe           2068   1556     57        0      1      0 2016-08-16 12:55:36 UTC+0000                                 
0x8ad60940 RuntimeBroker.         2196    576     21        0      1      0 2016-08-16 12:55:37 UTC+0000                                 
0x8ad5f040 SkypeHost.exe          2220    576     10        0      1      0 2016-08-16 12:55:37 UTC+0000                                 
0x8ad22c40 ShellExperienc         2432    576     38        0      1      0 2016-08-16 12:55:39 UTC+0000                                 
0x8b8520c0 SearchIndexer.         2532    488     17        0      0      0 2016-08-16 12:55:40 UTC+0000                                 
0x8b8fb8c0 OneDrive.exe           3592   2068     14        0      1      0 2016-08-16 12:55:57 UTC+0000                                 
0x9c68ec40 fontdrvhost.ex         4428    460      6        0      1      0 2016-08-16 12:57:09 UTC+0000                                 
0x9c728480 svchost.exe            4900    488      3        0      1      0 2016-08-16 12:57:21 UTC+0000                                 
0x8ad86c40 Skype.exe              5128   4696     64        0      1      0 2016-08-16 12:57:42 UTC+0000                                 
0x8c0c9240 TrustedInstall         6108    488      4        0      0      0 2016-08-16 12:58:24 UTC+0000                                 
0x8c0ba9c0 TiWorker.exe           6140    576      5        0      0      0 2016-08-16 12:58:25 UTC+0000                                 
0x9d489780 SystemSettings         2144    576      4        0      1      0 2016-08-16 12:59:36 UTC+0000                                 
0x9499ac40 ApplicationFra         1696    576      5        0      1      0 2016-08-16 12:59:48 UTC+0000                                 
0x9c629300 SystemSettings         5268   5252      4        0      1      0 2016-08-16 12:59:51 UTC+0000                                 
0xb0d47780 svchost.exe            4888   4748      2        0      1      0 2016-08-16 13:02:57 UTC+0000                                 
0x9d5e74c0 explorer.exe           4872   4748      3        0      1      0 2016-08-16 13:02:58 UTC+0000                                 
0x9c7d7c40 svchost.exe            2168   5860      2        0      1      0 2016-08-16 13:03:04 UTC+0000                                 
0xb0c96740 update.exe             5172   5860      6        0      1      0 2016-08-16 13:03:04 UTC+0000                                 
0xd0d9f600 cmd.exe                1976   5172      0 --------      1      0 2016-08-16 13:04:47 UTC+0000   2016-08-16 13:07:36 UTC+0000  
0x9d5ba900 cmd.exe                 736   5172      0 --------      1      0 2016-08-16 13:07:40 UTC+0000   2016-08-16 13:43:12 UTC+0000  
0xbac89640 SystemSettings         4968    576     26        0      1      0 2016-08-16 13:41:14 UTC+0000                                 
0xbad4b040 cmd.exe                2748   5172      0 --------      1      0 2016-08-16 13:50:51 UTC+0000   2016-08-16 14:08:30 UTC+0000  
0xbf755c40 cmd.exe                5280   5172      0 --------      1      0 2016-08-16 14:17:24 UTC+0000   2016-08-16 14:18:48 UTC+0000  
0x8b8c44c0 cmd.exe                 868   5172      0 --------      1      0 2016-08-16 14:19:45 UTC+0000   2016-08-16 14:23:02 UTC+0000  
0xd53d2c40 cmd.exe                3540   5172      0 --------      1      0 2016-08-16 14:23:05 UTC+0000   2016-08-16 14:23:46 UTC+0000  
0xd5321480 SearchUI.exe           7360    576     26        0      1      0 2016-08-16 18:13:21 UTC+0000                                 
0x9c6a8040 audiodg.exe           18084    848      7        0      0      0 2016-08-17 12:00:20 UTC+0000                                 
0xc8606c40 RamCapture.exe        16740   2068      4        0      1      0 2016-08-17 12:00:36 UTC+0000                                 
0xd53a3500 conhost.exe           16756  16740      2        0      1      0 2016-08-17 12:00:36 UTC+0000                                 
0x9c61a300 SearchProtocol        15756   2532      7        0 ------      0 2016-08-17 12:00:50 UTC+0000                                 
0xc7fa2a40 SearchFilterHo        14288   2532      5        0 ------      0 2016-08-17 12:00:50 UTC+0000                                 
0xe2df3040 MusNotificatio        16968    800      1        0 ------      0 2016-08-18 09:25:38 UTC+0000                                 
0xb0df7040 ?q???q??                  0      0 22...6 -------- ------      0 
</code></pre>

<p>On peut noter que le système à démarer à <strong>2016-08-16 12:54:24 UTC+0000</strong></p>
<pre><code class="text">0x868a7700 System                    4      0    104        0 ------      0 2016-08-16 12:54:24 UTC+0000
</code></pre>

<p>Cherchons les processus infectés vu précedemment</p>
<pre><code class="text">0xb0d47780 svchost.exe            4888   4748      2        0      1      0 2016-08-16 13:02:57 UTC+0000
0x9d5e74c0 explorer.exe           4872   4748      3        0      1      0 2016-08-16 13:02:58 UTC+0000
0xb0c96740 update.exe             5172   5860      6        0      1      0 2016-08-16 13:03:04 UTC+0000                                 
0xd0d9f600 cmd.exe                1976   5172      0 --------      1      0 2016-08-16 13:04:47 UTC+0000   2016-08-16 13:07:36 UTC+0000  
0x9d5ba900 cmd.exe                 736   5172      0 --------      1      0 2016-08-16 13:07:40 UTC+0000   2016-08-16 13:43:12 UTC+0000  
0xbad4b040 cmd.exe                2748   5172      0 --------      1      0 2016-08-16 13:50:51 UTC+0000   2016-08-16 14:08:30 UTC+0000  
0xbf755c40 cmd.exe                5280   5172      0 --------      1      0 2016-08-16 14:17:24 UTC+0000   2016-08-16 14:18:48 UTC+0000  
0x8b8c44c0 cmd.exe                 868   5172      0 --------      1      0 2016-08-16 14:19:45 UTC+0000   2016-08-16 14:23:02 UTC+0000  
0xd53d2c40 cmd.exe                3540   5172      0 --------      1      0 2016-08-16 14:23:05 UTC+0000   2016-08-16 14:23:46 UTC+0000
</code></pre>

<p>Quelques minutes après le Boot, xtremrat a lancé <strong>svchost.exe</strong> et <strong>explorer.exe</strong>. Puis <strong>update.exe</strong> à lancé plusieurs __cmd.exe_ à quelques minutes d'intervales. C'est suspect.</p>
<p>Il est possible de voir comment le processus a été lancé</p>
<p><strong>4888</strong></p>
<pre><code class="bash">vol dlllist -p 4888 | grep &quot;Command line&quot;

Command line : svchost.exe
</code></pre>

<p><strong>4872</strong></p>
<pre><code class="bash">vol dlllist -p 4872 | grep &quot;Command line&quot;

Command line : explorer.exe
</code></pre>

<p><strong>5172</strong></p>
<pre><code class="bash">vol dlllist -p 5172 | grep &quot;Command line&quot;

Command line : C:\Users\Peter\AppData\Roaming\HostData\update.exe
</code></pre>

<p><strong>1976</strong></p>
<pre><code class="bash">vol dlllist -p 1976 | grep &quot;Command line&quot;
</code></pre>

<p>On peut voir que update.exe a été lancé depuis un repertoire utilisateur : <strong>C:\Users\Peter\AppData\Roaming\HostData\update.exe</strong></p>
<p>De plus, il y a 2 processus <strong>explorer.exe</strong>, il devrait en avoir qu'un seul !</p>
<p>Si on regarde comment à été lancé le premier explorer.exe</p>
<pre><code class="bash">vol dlllist -p 2068 | grep &quot;Command line&quot;

Command line : C:\Windows\Explorer.EXE
</code></pre>

<p>Celui-ci est véridicte.</p>
<h2 id="analyse-des-traces-reseaux">Analyse des traces réseaux</h2>
<pre><code class="bash">vol netscan

Offset(P)          Proto    Local Address                  Foreign Address      State            Pid      Owner          Created
0x85b63230         TCPv4    192.168.5.100:59280            -:443                ESTABLISHED      -1                      
0x86963230         TCPv4    192.168.5.100:59280            -:443                ESTABLISHED      -1                      
0x8ada4678         UDPv4    127.0.0.1:512                  *:*                                   5128     Skype.exe      2016-08-16 12:57:46 UTC+0000
0x8ad0bc30         TCPv4    192.168.5.100:59277            0.0.0.29:80          ESTABLISHED      -1                      
0x8c15e930         UDPv4    0.0.0.0:0                      *:*                                   1132     svchost.exe    2016-08-17 12:01:09 UTC+0000
0x8c15e930         UDPv6    :::0                           *:*                                   1132     svchost.exe    2016-08-17 12:01:09 UTC+0000
0x8c16c008         UDPv4    0.0.0.0:512                    *:*                                   5128     Skype.exe      2016-08-17 12:01:04 UTC+0000
0x9490d480         UDPv4    0.0.0.0:512                    *:*                                   1132     svchost.exe    2016-08-17 12:00:28 UTC+0000
0x9492fbd8         UDPv4    0.0.0.0:0                      *:*                                   800      svchost.exe    2016-08-16 12:57:14 UTC+0000
0x94975f40         UDPv4    192.168.5.100:512              *:*                                   4        System         2016-08-17 12:00:28 UTC+0000
0x9497e008         UDPv6    fe80::28b6:9b1e:817d:11e5:5888 *:*                                   848      svchost.exe    2016-08-17 12:00:24 UTC+0000
0x94980a08         UDPv4    0.0.0.0:0                      *:*                                   1132     svchost.exe    2016-08-17 12:00:28 UTC+0000
0x94980a08         UDPv6    :::0                           *:*                                   1132     svchost.exe    2016-08-17 12:00:28 UTC+0000
0x949e14a8         UDPv4    0.0.0.0:0                      *:*                                   5128     Skype.exe      2016-08-16 12:57:46 UTC+0000
0x9a07c008         UDPv4    0.0.0.0:0                      *:*                                   5128     Skype.exe      2016-08-16 12:57:50 UTC+0000
0x9a07c008         UDPv6    :::0                           *:*                                   5128     Skype.exe      2016-08-16 12:57:50 UTC+0000
0x9a1986d0         UDPv4    0.0.0.0:512                    *:*                                   5128     Skype.exe      2016-08-16 12:57:50 UTC+0000
0x9a1aac18         UDPv4    0.0.0.0:5888                   *:*                                   1132     svchost.exe    2016-08-17 12:00:28 UTC+0000
0x9a1aac18         UDPv6    :::5888                        *:*                                   1132     svchost.exe    2016-08-17 12:00:28 UTC+0000
0x9a1e2c00         TCPv4    192.168.5.100:49864            -:443                ESTABLISHED      -1                      
0x9a1f3248         TCPv4    192.168.5.100:49847            -:12350              ESTABLISHED      -1                      
0x9c604050         UDPv4    192.168.5.100:512              *:*                                   4        System         2016-08-17 12:00:28 UTC+0000
0x9c61f418         UDPv4    0.0.0.0:5888                   *:*                                   1132     svchost.exe    2016-08-17 12:00:28 UTC+0000
0x9c61f418         UDPv6    :::5888                        *:*                                   1132     svchost.exe    2016-08-17 12:00:28 UTC+0000
0x9c653208         UDPv4    0.0.0.0:0                      *:*                                   5128     Skype.exe      2016-08-16 12:57:47 UTC+0000
0x9c653208         UDPv6    :::0                           *:*                                   5128     Skype.exe      2016-08-16 12:57:47 UTC+0000
0x9c739e40         UDPv4    0.0.0.0:0                      *:*                                   5128     Skype.exe      2016-08-16 12:57:47 UTC+0000
0x9c7f9228         UDPv4    0.0.0.0:512                    *:*                                   5128     Skype.exe      2016-08-16 12:57:50 UTC+0000
0x9d5677b0         TCPv4    192.168.5.100:58959            0.0.0.0:443          ESTABLISHED      -1                      
0xb0c1d3e0         UDPv4    0.0.0.0:0                      *:*                                   1132     svchost.exe    2016-08-17 12:00:57 UTC+0000
0xb0c1d3e0         UDPv6    :::0                           *:*                                   1132     svchost.exe    2016-08-17 12:00:57 UTC+0000
0xb9cf7a88         UDPv4    127.0.0.1:512                  *:*                                   856      svchost.exe    2016-08-17 12:00:25 UTC+0000
0xbad72db0         UDPv6    fe80::28b6:9b1e:817d:11e5:5888 *:*                                   856      svchost.exe    2016-08-17 12:00:25 UTC+0000
0xbece84f8         UDPv4    192.168.5.100:512              *:*                                   5128     Skype.exe      2016-08-17 12:01:04 UTC+0000
0xbed24df0         TCPv4    192.168.5.100:59220            -:12345              ESTABLISHED      -1                      
0xbf65e218         TCPv4    192.168.5.100:59271            -:12345              ESTABLISHED      -1                      
0xc5cd2150         UDPv4    192.168.5.100:512              *:*                                   856      svchost.exe    2016-08-17 12:00:25 UTC+0000
0xc6a698c8         UDPv6    ::1:5888                       *:*                                   856      svchost.exe    2016-08-17 12:00:25 UTC+0000
0xc6a21308         TCPv4    192.168.5.100:59250            -:443                ESTABLISHED      -1                      
0xc7278c70         TCPv4    192.168.5.100:59265            -:443                ESTABLISHED      -1                      
0xc7eacdb0         UDPv4    127.0.0.1:512                  *:*                                   856      svchost.exe    2016-08-17 12:00:25 UTC+0000
0xc7eace78         UDPv6    ::1:5888                       *:*                                   856      svchost.exe    2016-08-17 12:00:25 UTC+0000
0xc7ff31c0         UDPv4    192.168.5.100:512              *:*                                   856      svchost.exe    2016-08-17 12:00:25 UTC+0000
0xc7e81618         TCPv4    192.168.5.100:59246            -:443                ESTABLISHED      -1                      
0xc7eeadf0         TCPv4    192.168.5.100:59234            -:443                ESTABLISHED      -1                      
0xc7f9e760         TCPv4    192.168.5.100:59283            -:443                ESTABLISHED      -1                      
0xc865b008         UDPv6    fe80::3817:3c8c:3f57:fa9b:5888 *:*                                   848      svchost.exe    2016-08-17 12:00:25 UTC+0000
0xd0ccdd08         UDPv4    0.0.0.0:5888                   *:*                                   896      svchost.exe    2016-08-18 09:25:39 UTC+0000
0xd0ccdd08         UDPv6    :::5888                        *:*                                   896      svchost.exe    2016-08-18 09:25:39 UTC+0000
0xd0d33008         TCPv4    192.168.5.100:59269            -:443                ESTABLISHED      -1                      
0xd0dc2278         TCPv4    192.168.5.100:59268            -:33033              CLOSED           -1                      
0xd5216c68         UDPv4    0.0.0.0:512                    *:*                                   1132     svchost.exe    2016-08-17 12:00:28 UTC+0000
0xe2d145c8         TCPv4    192.168.5.100:59274            -:443                CLOSED           -1                      
0xf5d07008         UDPv6    fe80::28b6:9b1e:817d:11e5:5888 *:*                                   856      svchost.exe    2016-08-17 12:00:25 UTC+0000
</code></pre>

<p>On peut voir différentes connections vers des ports TCP peu communs, vers des destinations inconnues, pourant établies...  :</p>
<pre><code class="text">0x9a1f3248         TCPv4    192.168.5.100:49847            -:12350              ESTABLISHED      -1                      
0xbed24df0         TCPv4    192.168.5.100:59220            -:12345              ESTABLISHED      -1                      
0xbf65e218         TCPv4    192.168.5.100:59271            -:12345              ESTABLISHED      -1                      
0xd0dc2278         TCPv4    192.168.5.100:59268            -:33033              CLOSED           -1
</code></pre>

<h3 id="recapitulatif-de-lanalyse-memoire">Recapitulatif de l'analyse mémoire</h3>
<ul>
<li>Le systeme est infecté par un RAT nommé xtreme</li>
<li>Le malware se cache derriere des noms de processus officiels (explorer.exe)</li>
<li>Des connections TCP étranges relevées</li>
<li>Le deuxieme processus explorer.exe a été lancé depuis un répertoire utilisateur et a lancé de mutliples <strong>cmd.exe</strong>.</li>
</ul>
<h1 id="partie-3">Partie 3</h1>
<p><strong>Elements de preuve collectés via caine (sans volatility)</strong></p>
<h2 id="analyse-du-disque">Analyse du disque</h2>
<p>Il nous faut dans un premier temps repérer les partitions</p>
<pre><code class="bash">sudo mmls /media/sdb1/Windows/disk.raw 

Offset Sector: 0
Units are in 512-byte sectors

      Slot      Start        End          Length       Description
000:  Meta      0000000000   0000000000   0000000001   Primary Table (#0)
001:  -------   0000000000   0000002047   0000002048   Unallocated
002:  000:000   0000002048   0001026047   0001024000   NTFS / exFAT (0x07)
003:  000:001   0001026048   0050329599   0049303552   NTFS / exFAT (0x07)
004:  -------   0050329600   0050331647   0000002048   Unallocated
</code></pre>

<p>Cette partition est la principale, c'est la plus grosse.</p>
<pre><code class="text">003:  000:001   0001026048   0050329599   0049303552   NTFS / exFAT (0x07)
</code></pre>

<p>Il est précisé <strong>Units are in 512-byte sectors</strong>, pour monter la partition il faut préciser l'offset : </p>
<pre><code class="text">1026048 * 512 = 525336576
</code></pre>

<pre><code class="bash">sudo mkdir /mnt/partition
sudo mount -t ntfs -o ro,offset=525336576 /media/sdb1/Windows/disk.raw /mnt/partition/
ls /mnt/partition/

autoexec.bat  BOOTNXT     pagefile.sys  ProgramData    Recovery      swapfile.sys               Users
bootmgr       config.sys  PerfLogs      Program Files  $Recycle.Bin  System Volume Information  Windows
</code></pre>

<p>Lançons <strong>autopsy</strong> et créons un nouveau cas avec le disque dur : </p>
<ul>
<li>Créer un nouveau cas.</li>
<li>Ajouter l'image disque <strong>/media/sdb1/windows/disk.raw</strong>.</li>
<li>Selectionner la plus grande partition.</li>
<li>
<p>Lancer un <strong>File Activity Time Line</strong> sur la partition.</p>
<p>1) <strong>Create Data File</strong> et selectionner la partition.</p>
<p><code>text
Running fls -r -m on vol2
Body file saved to /usr/share/caine/report/autopsy/EvidenceC/WindowsEvidence/output/body
Entry added to host config file
Calculating MD5 Value
MD5 Value: 139C867C50F5C5FC39C69FAB00A50043</code></p>
<p>2) <strong>Create Timeline</strong>
    * Bien préciser la date de début en se basant sur la date de lancement de l'ordi <strong>2016-08-16 12:54:24 UTC+0000</strong>.
    * On obtient le timeline complet.</p>
</li>
</ul>
<pre><code class="bash">cat /usr/share/caine/report/autopsy/EvidenceC/WindowsEvidence/output/timeline.txt | grep update.exe

86 macb r/r--x--x--x 0        0        101287-48-2 D:/Users/Peter/AppData/Roaming/HostData/update.exe ($FILE_NAME)
61440 ..c. r/r--x--x--x 0        0        101287-128-1 D:/Users/Peter/AppData/Roaming/HostData/update.exe
</code></pre>

<blockquote>
<p>M : fichier modidifié
A : Accès au fichier
C : Metadata changées
B : fichier créé</p>
</blockquote>
<p>On voit que le fichier <strong>D:/Users/Peter/AppData/Roaming/HostData/update.exe</strong> a bien été ajouté.</p>
<h2 id="scan-antivirus">Scan antivirus</h2>
<p>Scannons la partition précédement montée à l'aide de l'antivirus <strong>clamav</strong></p>
<pre><code class="text">sudo clamscan -i -r /mnt/partition/ &gt; ~/clamscan.txt
cat ~/clamscan.txt

/mnt/partition/Users/Peter/AppData/Local/Microsoft/Windows/INetCache/IE/R81B6P1C/3568226350[1].exe: Win.Trojan.Xtreme-7 FOUND
/mnt/partition/Users/Peter/AppData/Local/Mozilla/Firefox/Profiles/z0l7z3kd.default/cache2/entries/394A23D50D9098F50B10713FD54607815F18FAB8: Html.Exploit.CVE_2012_3993-1 FOUND
/mnt/partition/Users/Peter/AppData/Local/Temp/svchost.exe: Win.Trojan.Xtreme-7 FOUND
/mnt/partition/Users/Peter/AppData/Roaming/EpUpdate/bpd/BrowserPasswordDump.exe: Win.Dropper.Securityxploded-6871294-0 FOUND
/mnt/partition/Users/Peter/AppData/Roaming/EpUpdate/mmktz/mimikatz.exe: Win.Trojan.Mimikatz-6466236-0 FOUND
/mnt/partition/Users/Peter/AppData/Roaming/EpUpdate/mmktz/mimilib.dll: Win.Tool.Mimikatz-9784738-0 FOUND
/mnt/partition/Users/Peter/AppData/Roaming/EpUpdate/pwdump/PwDump7.exe: Win.Trojan.Pwdump-1 FOUND
/mnt/partition/Users/Peter/AppData/Roaming/HostData/update.exe: Win.Trojan.Xtreme-7 FOUND

----------- SCAN SUMMARY -----------
Known viruses: 8798148
Engine version: 0.98.7
Scanned directories: 18803
Scanned files: 117500
Infected files: 8
Data scanned: 8081.59 MB
Data read: 12881.35 MB (ratio 0.63:1)
Time: 2114.496 sec (35 m 14 s)
</code></pre>

<p>Resultat : </p>
<ul>
<li>Un fichier dans firefox vulnérable à la <strong>CVE-2012-3993</strong></li>
<li>Un fichier cache dans INetCache contient un <strong>Win.Trojan.Xtrem-7</strong></li>
<li>L'<strong>update.exe</strong> suspecté est bien infecté par le <strong>Win.Trojan.Xtrem-7</strong></li>
<li>Un fichier <strong>BrowserPasswordDump.exe</strong> infecté par un <strong>Win.Trojan.Pwdump-1</strong> trouvé dans le dossier EpUpdate. </li>
</ul>
<p>Le fichier <strong>update.exe</strong> est impliqué.
Nous allons observer avec autopsy les fichiers, notament le dossier EpUpdate / INetCache et HostData\update.exe</p>
<ul>
<li><strong>EpUpdate</strong></li>
</ul>
<pre><code class="text">bpd/ - BrowserPasswordDump.exe
mmktz/ - mimikatz
nircmd/ – NirCmd
nmap/ - Nmap
pwdump/ - Pwdump
ssh/ - plink, pscp
thc/ - THC Hydra
passwords.txt – une wordlist de mot de passe
wdigest.reg – un outil pour modifier les registres
</code></pre>

<ul>
<li><strong>HostData/update.exe</strong></li>
</ul>
<pre><code class="text">    File Name       Modified/Written Time           Access Time                     Change Time                     Create Time
    update.exe      2005-06-03 07:01:04 (GMT)       2005-06-03 07:01:04 (GMT)       2016-08-16 13:03:04 (GMT)       2005-06-03 07:01:04 (GMT)
</code></pre>

<p>Le fichier a bien été modifié le 2016-08-16 13:03:04.</p>
<ul>
<li><strong>INetCacheIE/R81B6P1C/3568226350[1].exe</strong></li>
</ul>
<pre><code class="text">000088D0:  5800 5400 5200 4500 4D00 4500 0D00 4900    X.T.R.E.M.E...I.
</code></pre>

<p>On retrouve dans la vue Hexa la signature du RAT : <strong>XTREME</strong> ainsi que methode <strong>URLDownloadToFile</strong></p>
<pre><code class="text">0000EE10:  7957 0000 5552 4C44 6F77 6E6C 6F61 6454    yW..URLDownloadT
0000EE20:  6F46 696C 6557 0000 4368 6172 4E65 7874    oFileW
</code></pre>

<p>On peut présumer que le RAT xtrem a été téléchargé depuis le navigateur firefox.</p>
<h2 id="historique-de-firefox">Historique de firefox</h2>
<p>L'historique de navigation de firefox se trouve ici : <strong>C:/Users/Peter/AppData/Local/Mozilla/Firefox/Profiles/Peter/places.sqlite</strong>.</p>
<p>Nous allons utiliser l'outil <strong>BrowsingHistoryView.exe.</strong> pour analyser l'historique de navigation.</p>
<pre><code class="bash">wine BrowsingHistoryView.exe
</code></pre>

<p>L'utilisateur a visiter quelques sites le jours de l'attaque : </p>
<ul>
<li>reddit</li>
<li>skype</li>
<li>msn</li>
<li>blog.mycompany.ex</li>
</ul>
<p>Aucune information sur le téléchargement d'un quelconque fichier ... Allons voir dans le cache.</p>
<pre><code class="text">cd /mnt/partition/Users/Peter/AppData/Local/Mozilla/Firefox/Profiles/z0l7z3kd.default/cache2 

head index
pd=���4�Y�,$X�z���|�&lt;��K|����
�B�i    珦���)�N�_�!&lt;�!�������E�/�~
</code></pre>

<p>C'est un binaire ... Utilisons l'outil <strong>MZCacheView</strong></p>
<p>L'analyse du site de l'enteprise montre une requete en javascript qui pointe vers <strong>http://blog.mysportclub.ex/wpcontent/uploads/hk/task/opspy/index.php.</strong>. Probablement infecté ! </p>
<p>On remarque de multiple iframe imbriquées pointant vers différents liens, tous du site <strong>blog.mysportclub.ex</strong>
Ce sont des test de vulnérabilités.</p>
<p>C'est de là que le service svchost a été téléchargé puis lancé (xtrem RAT).</p>
<h1 id="partie-4">Partie 4</h1>
<p><strong>Timeline (jour/heures/minutes secondes) de ce qu'il se passe sur la machine infectée (pensez à renvoyer en annotation pour chaque étape de la timeline la preuve trouvée durant la dead analysys, soit via volatility, soit via caine sur le dump de disque).</strong></p>
<ul>
<li>Création <strong>D:/Users/Peter/AppData/Roaming/HostData/update.exe</strong> </li>
</ul>
<blockquote>
<p><code>Tue  Aug 16 2016 13:02:57  : 86    macb    r/r--x--x--x    0   0   101287-48-2 D:/Users/Peter/AppData/Roaming/HostData/update.exe ($FILE_NAME)</code></p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Heure</th>
<th align="center">description</th>
<th align="center">source</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">12:54:24</td>
<td align="center">Demarrage du premier process (boot pc)</td>
<td align="center">Volatility</td>
</tr>
<tr>
<td align="center">13:02:46</td>
<td align="center">Peter se rends sur la page http://blog.mycompany.ex/</td>
<td align="center">Historique firefox</td>
</tr>
<tr>
<td align="center">13:03:17</td>
<td align="center">Redirection vers http://blog.mysportclub.ex et téléchargement du malware en cache</td>
<td align="center">Historique firefox &amp; analyse du cache</td>
</tr>
<tr>
<td align="center">13:02:53</td>
<td align="center">Création du fichier cache contenant le malware XTREM</td>
<td align="center">analyse du cache &amp; ClamAV analyse</td>
</tr>
<tr>
<td align="center">13:02:57</td>
<td align="center">Démarage du service svchost.exe contenant le RAT</td>
<td align="center">Volatility</td>
</tr>
<tr>
<td align="center">13:03:04</td>
<td align="center">Démarage d'un deuxième explorer.exe</td>
<td align="center">Volatility</td>
</tr>
<tr>
<td align="center">13:03:04</td>
<td align="center">Démarage de update.exe</td>
<td align="center">volatility</td>
</tr>
<tr>
<td align="center">13:07:36</td>
<td align="center">Démarrage de plusieurs processus cmd.exe</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">13:14:47</td>
<td align="center">Création du dossier EpUpdate</td>
<td align="center">Autopsy et analyse de fichier</td>
</tr>
</tbody>
</table>
<h1 id="partie-5">Partie 5</h1>
<p><strong>Conclusion A : Que faudrait il faire pour nettoyer cet ordinateur?</strong></p>
<ul>
<li>Supprimer tous les fichier infectés et ajoutés par l'attaquant</li>
<li>Supprimer le cache dans Firefox</li>
<li>Mettre à jour Firefox et toutes les applications du PC</li>
</ul>
<h1 id="partie-6">Partie 6</h1>
<p><strong>Conclusion B:As t'on des indices suffisants pour dire qu'il y a eu exfiltration de données, si oui, quels indices, et quelles données? Si non, y a t'il des indices qui peuvent aider à savoir si des données ont été exfiltrées.</strong></p>
<ul>
<li>Au vu des résultats que l'on a obtenu, on peut prétendre que des données ont étés exfiltrées, de pars les multiples requêtes vers des hôtes inconnues et le nombre d'outil serveur à de l'audit trouvés dans le dossier <strong>EpUpdate</strong>. Il faudrait regarder les logs réseaux, dans le SO (si il y en a un) pour voir ce qui a transité.</li>
</ul>
<h1 id="partie-7">Partie 7</h1>
<p><strong>Conclusion C: Que préconisez-vous de faire pour que cette attaque ne puisse plus se reproduire sur d'autres ordinateurs de l'entreprise? On pourra imaginer tout ce que vous voulez, du moment que ce n'est pas une usine a gas ingérable.</strong></p>
<ul>
<li>L'installation d'un IDS/NSM tel que Security Onion. Complexe mais efficace.</li>
<li>Sinon, un anti-virus aurait probablement détecté le RAT Extrem.</li>
<li>De nombreux routeurs font de l'IDS/IPS</li>
<li>Un serveur syslog est toujours un bon points pour garder des traces.</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../exercices/dump_mem_disk/" class="btn btn-neutral float-right" title="Dump mémoire et disque dur">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Evidence/" class="btn btn-neutral" title="Evidence"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Evidence/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../exercices/dump_mem_disk/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>

</body>
</html>
