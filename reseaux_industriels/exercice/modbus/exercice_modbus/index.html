<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../../img/favicon.ico">
  <title>Exercices modbus - Cours - GJ enterprise</title>
  <link rel="stylesheet" href="../../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Exercices modbus";
    var mkdocs_page_input_path = "reseaux_industriels/exercice/modbus/exercice_modbus.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../../.." class="icon icon-home"> Cours - GJ enterprise</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <span class="caption-text">cloud & IOT</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../cloud_&_IOT/cloud_computing/">Cloud computing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../cloud_&_IOT/cours/">FAOU_Julien_Stuxnet</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Forensic</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../forensic/autopsy/">Autopsy</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../forensic/cours_forensic/">Forensic</a>
                </li>
                <li class="">
                    
    <span class="caption-text">Evidence</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../../forensic/evidence/Evidence/">Evidence</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../../forensic/evidence/FAOU_Julien_Evidence/">FAOU_Julien_Evidence</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Exercices</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../../forensic/exercices/dump_mem_disk/">Dump mémoire et disque dur</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">Volatility</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../../forensic/exercices/volatility/exercice2/">Forensic exercice 2 - Volatility</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Stuxnet</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../../forensic/stuxnet/Julien_Faou_Stuxnet/">FAOU_Julien_Stuxnet</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Management</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../management/Partiel_droit_Julien_Faou/">Partiel droit</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../management/STMicroelectronics/">STMicroelectronics</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../management/donnes_personnelles/">Comment traiter les données collectées ?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../management/exploitation_base_de_donne/">L'exploitation de base de données</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../management/proteger_le_travail/">Proteger le travail</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Memoire entreprise</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../memoire_entreprise/instruction_memoire_entreprise/">Instruction memoire entreprise</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Methodologie pentest</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../methodologie_pentest/cours/">Enumération passive</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../methodologie_pentest/cyberwings/">Collect email</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../methodologie_pentest/methodologie_pentest/">Méthodologie de pentest</a>
                </li>
                <li class="">
                    
    <span class="caption-text">ISSAF</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../../methodologie_pentest/ISSAF/DE-ICE-110/">DE-ICE-110 - Pentest</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../../methodologie_pentest/ISSAF/GoldenEye-V1/">GoldenEye V1</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../../methodologie_pentest/ISSAF/template_ISSAF/">Méthodologie template - Pentest</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Exercices</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../../methodologie_pentest/exercices/sectools.org/">Sectools.org</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Wiki</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../../methodologie_pentest/wiki/pentesting_ftp/">Pentesting FTP</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../../methodologie_pentest/wiki/privilege_escalation/">Gather system informations</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Reseaux industriels</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../grafcet/">Graphset</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../reseaux_industriel/">Réseaux industriels</a>
                </li>
                <li class=" current">
                    
    <span class="caption-text">Exercice</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <span class="caption-text">Grafcet</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../grafcet/grafcet_instructions/">Grafcet instructions</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3 current">
                    
    <span class="caption-text">Modbus</span>
    <ul class="subnav">
                <li class="toctree-l4 current">
                    
    <a class="current" href="./">Exercices modbus</a>
    <ul class="subnav">
            
    <li class="toctree-l5"><a href="#exercices-modbus">Exercices modbus</a></li>
    
        <ul>
        
            <li><a class="toctree-l6" href="#julien-faou">Julien Faou</a></li>
        
            <li><a class="toctree-l6" href="#installation-modbus">Installation modbus</a></li>
        
            <li><a class="toctree-l6" href="#exercice-1-compromission-avec-modbus-cli">Exercice 1 - Compromission avec modbus-cli</a></li>
        
            <li><a class="toctree-l6" href="#exercice-2-scan-avec-nmap">Exercice 2 - Scan avec Nmap</a></li>
        
            <li><a class="toctree-l6" href="#exercice-3-recherche-dexploit">Exercice 3 - Recherche d'exploit</a></li>
        
            <li><a class="toctree-l6" href="#exercice-4-avec-scapy">Exercice 4 - Avec Scapy</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Securite reseaux industrielles</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../securite_reseaux_industrielles/cours/">Securité des réseaux industriels</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">securité IOT</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../securité_IOT/cours/">Cours</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../..">Cours - GJ enterprise</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Modbus &raquo;</li>
        
      
        
          <li>Exercice &raquo;</li>
        
      
        
          <li>Reseaux industriels &raquo;</li>
        
      
    
    <li>Exercices modbus</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="exercices-modbus">Exercices modbus</h1>
<h5 id="julien-faou">Julien Faou</h5>
<h2 id="installation-modbus">Installation modbus</h2>
<pre><code>sudo pip3 install pyModbus
</code></pre>

<h2 id="exercice-1-compromission-avec-modbus-cli">Exercice 1 - Compromission avec modbus-cli</h2>
<pre><code>sudo modbus read -h
Usage:
    modbus read [OPTIONS] HOST ADDRESS COUNT

Parameters:
    HOST                             IP address or hostname for the Modbus device
    ADDRESS                          Start address (eg %M100, %MW100, 101, 400101)
    COUNT                            number of data to read

Options:
    -w, --word                       use unsigned 16 bit integers
    -i, --int                        use signed 16 bit integers
    -d, --dword                      use unsigned 32 bit integers
    -f, --float                      use signed 32 bit floating point values
    --modicon                        use Modicon addressing (eg. coil: 101, word: 400001)
    --schneider                      use Schneider addressing (eg. coil: %M100, word: %MW0, float: %MF0, dword: %MD0)
    -s, --slave ID                   use slave id ID (default: 1)
    -p, --port PORT                  use TCP port (default: 502)
    -o, --output FILE                write results to file FILE
    -D, --debug                      show debug messages
    -T, --timeout TIMEOUT            Specify the timeout in seconds when talking to the slave
    -C, --connect-timeout TIMEOUT    Specify the timeout in seconds when connecting to TCP socket
    -h, --help                       print help
</code></pre>

<p><strong>A l’aide de la commande modbus read, lisez les 5 premiers registres de type bit</strong></p>
<pre><code>sudo modbus 192.168.43.161 1 5
</code></pre>

<pre><code>1          1
2          1
3          1
4          1
5          1
</code></pre>

<p><img alt="" src="../images/modbus_1.png" /></p>
<p><strong>A l’aide de la commande modbus read, isez les 5 premiers registres entiers</strong></p>
<pre><code>sudo modbus read 192.168.43.161 400001 5
</code></pre>

<pre><code>400001         17
400002         17
400003         17
400004         17
400005         17
</code></pre>

<p><img alt="" src="../images/modbus_2.png" /></p>
<p><strong>A l’aide de write, modifier un entier parmi les 5 premiers entiers</strong></p>
<pre><code>sudo modbus write -h
</code></pre>

<pre><code>Usage:
    modbus write [OPTIONS] HOST ADDRESS VALUES ...

Parameters:
    HOST                             IP address or hostname for the Modbus device
    ADDRESS                          Start address (eg %M100, %MW100, 101, 400101)
    VALUES ...                       values to write, nonzero counts as true for discrete values

Options:
    -w, --word                       use unsigned 16 bit integers
    -i, --int                        use signed 16 bit integers
    -d, --dword                      use unsigned 32 bit integers
    -f, --float                      use signed 32 bit floating point values
    --modicon                        use Modicon addressing (eg. coil: 101, word: 400001)
    --schneider                      use Schneider addressing (eg. coil: %M100, word: %MW0, float: %MF0, dword: %MD0)
    -s, --slave ID                   use slave id ID (default: 1)
    -p, --port PORT                  use TCP port (default: 502)
    -D, --debug                      show debug messages
    -T, --timeout TIMEOUT            Specify the timeout in seconds when talking to the slave
    -C, --connect-timeout TIMEOUT    Specify the timeout in seconds when connecting to TCP socket
    -h, --help                       print help
</code></pre>

<pre><code>sudo modbus write -i 192.168.43.161 400002 6
</code></pre>

<p><img alt="" src="../images/modbus_3.png" /></p>
<pre><code>sudo modbus read -i 192.168.43.161 400002 1
</code></pre>

<pre><code>400002          6
</code></pre>

<p><strong>A l’aide de write, modifier un booléen parmi les 5 premiers booléens modifiables</strong></p>
<pre><code>sudo modbus write 192.168.43.161 3 0
</code></pre>

<p><img alt="" src="../images/modbus_4.png" /></p>
<pre><code>sudo modbus read 192.168.43.161 3 1
</code></pre>

<pre><code>3          0
</code></pre>

<h2 id="exercice-2-scan-avec-nmap">Exercice 2 - Scan avec Nmap</h2>
<p><strong>Executer un nmap avec un script nse dédié à l’énumération pour modbus</strong></p>
<pre><code>nmap --script-help &quot;*modbus*&quot;
</code></pre>

<pre><code>Starting Nmap 7.80 ( https://nmap.org ) at 2020-09-01 14:24 CEST

modbus-discover
Categories: discovery intrusive
https://nmap.org/nsedoc/scripts/modbus-discover.html
  Enumerates SCADA Modbus slave ids (sids) and collects their device information.

  Modbus is one of the popular SCADA protocols. This script does Modbus device
  information disclosure. It tries to find legal sids (slave ids) of Modbus
  devices and to get additional information about the vendor and firmware. This
  script is improvement of modscan python utility written by Mark Bristow.

  Information about MODBUS protocol and security issues:
  * MODBUS application protocol specification:  http://www.modbus.org/docs/Modbus_Application_Protocol_V1_1b.pdf
  * Defcon 16 Modscan presentation: https://www.defcon.org/images/defcon-16/dc16-presentations/defcon-16-bristow.pdf
  * Modscan utility is hosted at google code: http://code.google.com/p/modscan/
</code></pre>

<pre><code>nmap -p502 --script modbus-discover.nse 192.168.43.161
</code></pre>

<pre><code>Starting Nmap 7.80 ( https://nmap.org ) at 2020-09-02 09:21 CEST
Nmap scan report for 192.168.43.161
Host is up (0.0018s latency).

PORT    STATE SERVICE
502/tcp open  modbus
| modbus-discover: 
|   sid 0x1: 
|     Slave ID data: PyModbus Inc.-PM-1.0\xFF
|_    Device identification: PyModbus Inc. PM 1.0

Nmap done: 1 IP address (1 host up) scanned in 0.30 seconds
</code></pre>

<p><img alt="" src="../images/modbus_5.png" /></p>
<p><img alt="" src="../images/modbus_6.png" /></p>
<h2 id="exercice-3-recherche-dexploit">Exercice 3 - Recherche d'exploit</h2>
<p><strong>Trouver au moins un exploit existant dans exploit-db.com concernant un serveur modbus</strong></p>
<p><img alt="" src="../images/modbus_7.png" /></p>
<h2 id="exercice-4-avec-scapy">Exercice 4 - Avec Scapy</h2>
<pre><code>ip=IP(src='192.168.118.128',dst='192.168.43.161')
tcp=TCP(sport=6666,dport=502,flags='S')
pkt=ip/tcp                                 
pkt.show()      

###[ IP ]### 
  version= 4
  ihl= None
  tos= 0x0
  len= None
  id= 1
  flags= 
  frag= 0
  ttl= 64
  proto= tcp
  chksum= None
  src= 192.189.118.128
  dst= 192.168.43.161
  \options\
###[ TCP ]### 
     sport= 6666
     dport= 502
     seq= 0
     ack= 0
     dataofs= None
     reserved= 0
     flags= S
     window= 8192
     chksum= None
     urgptr= 0
     options= []

send(pkt)
</code></pre>

<pre><code>answ=sr1(pkt)
</code></pre>

<pre><code>answ=sr1(pkt)                     
Begin emission:
.Finished sending 1 packets.
*
Received 2 packets, got 1 answers, remaining 0 packets
</code></pre>

<pre><code>answ.show()
</code></pre>

<pre><code>###[ IP ]### 
  version= 4
  ihl= 5
  tos= 0x0
  len= 44
  id= 65409
  flags= 
  frag= 0
  ttl= 128
  proto= tcp
  chksum= 0x17d8
  src= 192.168.43.161
  dst= 192.168.118.128
  \options\
###[ TCP ]### 
     sport= 502
     dport= 6666
     seq= 1364939808
     ack= 1
     dataofs= 6
     reserved= 0
     flags= SA
     window= 64240
     chksum= 0xb836
     urgptr= 0
     options= [('MSS', 1460)]
###[ Padding ]### 
        load= '\x00\x00'
</code></pre>

<p><strong>Rechercher un framework (lmot clé smod?) pour scapy permettant de crafter des requetes vers des serveurs modbus</strong></p>
<ul>
<li>Dans le script "asyncmodbus.py" utilisé pour créer le serveur, la library <strong>pymodbus</strong> est utilisé.
Voici la documentation : https://pymodbus.readthedocs.io/en/latest/index.html</li>
</ul>
<h3 id="read-and-write-boolean">Read and write boolean</h3>
<pre><code>from pymodbus.client.sync import ModbusTcpClient

client = ModbusTcpClient('192.168.43.161')
client.write_coil(1, False)
result = client.read_coils(1,1)
print(result.bits[0])
client.close()
</code></pre>

<pre><code>False
</code></pre>

<pre><code>from pymodbus.client.sync import ModbusTcpClient

client = ModbusTcpClient('192.168.43.161')
client.write_coil(1, True)
result = client.read_coils(1,1)
print(result.bits[0])
client.close()
</code></pre>

<pre><code>True
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../../securite_reseaux_industrielles/cours/" class="btn btn-neutral float-right" title="Securité des réseaux industriels">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../grafcet/grafcet_instructions/" class="btn btn-neutral" title="Grafcet instructions"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../../grafcet/grafcet_instructions/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../../../securite_reseaux_industrielles/cours/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../../..';</script>
    <script src="../../../../js/theme.js" defer></script>
      <script src="../../../../search/main.js" defer></script>

</body>
</html>
